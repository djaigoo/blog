---
author: djaigo
title: 长连接设计思考
categories:
  - think
tags:
date: 2021-03-01 10:41:20
---

# 简介
长连接是指长时间处于可以传输数据的网络连接，短连接指建连后很快断开的网络连接。
常见的短连接是http1.0协议，一条连接只用于发送请求接收响应，断开连接。频繁建立和关闭连接会有性能损耗，所以http1.1支持keep-alive来保活连接，让连接可以传输多个请求响应对。为了增大连接使用率，http2支持同时传输多个请求响应对。
通过对http协议发展分析，从使用连接到复用连接再到高效复用连接，这也是长连接的发展方向。
# 连接
## 传输层协议
常见的传输层协议有tcp、udp、kcp、quic等。
## 保活
通过保活机制可以确保连接的有效性，常见的保活机制有心跳、探活等。
## 会话
一个连接表示一个会话，可以理解成会话信息与连接有所绑定。
### 客户端
使用长连接提供服务的都可以称作客户端（client）。
### 对端
同为向外提供长连接服务的都可以称作对端（peer）。
## 单机房
长连接作为一个系统，每个部分都有自己的分工，有网关，分发服务，中心服务等。
## 多机房
长连接作为最基本的服务，需要多活作为基础保障，导致的问题就是多机房同步问题。
## 边缘节点
偏远地区部署机房就会浪费资源，直连机房又有网络连接不确定性，通过连接边缘节点，内部直接走内网或骨干网连接机房，大大提高了网络传输效率和稳定性。
# 传输
连接建立稳定后，就需要考虑连接上传输的包的内容。
## 报文
### http
### http2
### mqtt
### 自定义报文
## 数据包
有了传输协议后，就需要描述数据的内容。
### raw
### json
### thrift
### protocol buffer
### 自定义数据包
# 关闭
当不用连接后，怎样优雅的关闭也是一个问题。
## 平滑关闭
等待链路上信息已经传输完毕，断开连接。
## 平滑重启
## 平滑迁移
# 埋点
系统内置操作不能满足系统
# 方案
## http
## http2
## mqtt